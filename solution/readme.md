### Build Status

[![Build Status](https://dev.azure.com/bhatnitesh/TechChallengeApp/_apis/build/status/niteshbhat.TechChallengeApp?branchName=master)](https://dev.azure.com/bhatnitesh/TechChallengeApp/_build/latest?definitionId=4&branchName=master)


### Pre-Request
1. **Registry/Repository: Docker HUB**

* We need to make sure that we have a registry service running in our environment, I am using Docker HUB as a registry/repository where I can upload the container images generated by dockerfile. For example we are using a Public registry by name for this task: **evila/tech-challenge** (https://hub.docker.com/repository/docker/evila/tech-challenge)
<img width="912" alt="image" src="https://user-images.githubusercontent.com/7299171/178062819-7bb89161-8bfe-4fff-a5f2-502b3326427d.png">

 2. **CI/CD: Azure Pipeline**
 
 * we have to create or in the current org we have to create a new project here I have created a project
   with the name: TechChallengeApp (https://dev.azure.com/bhatnitesh/TechChallengeApp).
   <img width="941" alt="image" src="https://user-images.githubusercontent.com/7299171/178062891-78958209-7b0f-4e7b-83c2-85857958c2bb.png">

 * In the Project setting, we need to configure some service Connections which we are using in the project
   
   * **Github** ( Secure connection with Github Repo:https://github.com/niteshbhat/TechChallengeApp)
   * **Docker Registry** ( created secure connection to my registry https://hub.docker.com/repository/docker/evila)
   * **ARM** ( here ARM name we are using is Azure subscription for secure connection"
   * **Azure Classic**
   <img width="371" alt="image" src="https://user-images.githubusercontent.com/7299171/178063064-1d5325bf-a5fd-4ace-bab8-c6583130df81.png">
 
 After that, we have to make sure each above service connections have permission to use in pipeline example: **niteshbhat.TechChallengeApp**.
 
 * Configure a pipeline by selecting "Existing Azure Pipelines" and link the repo https://github.com/niteshbhat/TechChallengeApp/solution/Build/build.yml)
 * We need to install some of new extensions from Azure Marketplace in the Azure DevOps pipeline which we are going to use in the pipeline
   **Terraform**
    1)Terraform VSTS build task
    2)Terraform (Microsoft Dev Lab)
    3)Terraform Import
    <img width="398" alt="image" src="https://user-images.githubusercontent.com/7299171/178063144-f93b25f4-b414-46b2-aacb-083af3ce7f5b.png">

 * Make sure the Parallel job should be enabled to run the agent job
 <img width="331" alt="image" src="https://user-images.githubusercontent.com/7299171/178063316-a9b032a3-a265-4da5-9738-c8562edc3419.png">
 <img width="314" alt="image" src="https://user-images.githubusercontent.com/7299171/178063363-d41f99b9-fc12-4b1e-824d-bd298b35a077.png">

3. Created Container storage account to store the statefile for the terraform 
<img width="754" alt="image" src="https://user-images.githubusercontent.com/7299171/178136582-307d5e43-9b68-41c1-a794-be2ea4743237.png">


### Description
Here we are using Azure devOps Pipeline we are tring to use dockerfile to build the container image and upload the it in docker hub and in same pipeline we have added 
code to run terraform code which will take care to build the application in running in container.


<details><summary>Enviroment Variable</summary>
<p>

#### Terraform { var.PASSWORD }

```
variable "PASSWORD" {
  description = "Database administrator password"
  type        = string
  sensitive   = true
}

variable "rg_name" {
  description = "variable contain the name of resource group"
  type    = string
  default = "az-servian-rg"
}

variable "tags" {
  description = "Tag to decided the env of infra"
  type = map
  default = {
    "env" = "dev"
  }
}

variable "location" {
  description = "Infra Application Location"
  type    = string
  default = "West US"
}


variable "servian-aci" {
  
  type = map
  default = {
    "name"             = "servian-techchallenge"
    "dns_label"        = "servian-techchallenge"
    "container1_name"  = "postgres"
    "container1_image" = "postgres:latest"
    "container2_name"  = "tech-challenge"
    "container2_image" = "evila/tech-challenge:latest"
    "DbHost"           = "localhost"
    "ListenHost"       = "0.0.0.0"
    "ListenPort"       = "80"
  }
}

```
 
</p>
</details>
<details><summary>Terraform resource used</summary>
<p>

#### azurerm_resource_group

```
  resource "azurerm_resource_group" "az-rg" {
  name     = var.rg_name
  location = var.location
}
```
#### azurerm_container_group

```
  resource "azurerm_container_group" "servian-az-aci" {
  name                = var.servian-aci["name"]
  location            = azurerm_resource_group.az-rg.location
  resource_group_name = azurerm_resource_group.az-rg.name
  ip_address_type     = "Public"
  dns_name_label      = var.servian-aci["dns_label"]
  os_type             = "Linux"
 
  container {
    name   = var.servian-aci["container1_name"]
    image  = var.servian-aci["container1_image"]
    cpu    = "1.0"
    memory = "1.5"
    secure_environment_variables = {
      "VTT_DBHOST"        = var.servian-aci["DbHost"]
      "POSTGRES_PASSWORD" = "changeme"
      "VTT_LISTENHOST"    = var.servian-aci["ListenHost"]
    }

  }

  container {
    name     = var.servian-aci["container2_name"]
    image    = var.servian-aci["container2_image"]
    cpu      = "1.0"
    memory   = "1.5"
    commands = ["/bin/sh", "-c", "sleep 10 ;  ./TechChallengeApp updatedb; ./TechChallengeApp serve"]
    secure_environment_variables = {
      "VTT_DBHOST"     = var.servian-aci["DbHost"]
      "VTT_DBPASSWORD" = "changeme"
      "VTT_LISTENPORT" = var.servian-aci["ListenPort"]
      "VTT_LISTENHOST" = var.servian-aci["ListenHost"]
    }
    ports {
      port = 80
    }
  
  }
}
}
```  
</p>
</details>

### Solution

* We have uploaded the solution of the challenge in  Solution folder(https://github.com/niteshbhat/TechChallengeApp/tree/master/solution)
  <img width="569" alt="image" src="https://user-images.githubusercontent.com/7299171/178064334-12ae8203-7818-4cd6-b9da-ffb2e287cb32.png">
 
      - Build --> Here we have YML file which were used to run the application piple line 
                    1) Build the image from DockerFile
                    2) using below terraform project deploy the artifcates to ACI 
  <img width="691" alt="image" src="https://user-images.githubusercontent.com/7299171/178064478-941ae0b6-5a86-4f39-9608-19103a36ce2e.png">
  <img width="176" alt="image" src="https://user-images.githubusercontent.com/7299171/178064612-96adb8c4-c5d8-4bec-8ab8-42db36c58bc6.png">


      - Infra --> Terraform templete is present in this folder which help to create application running the application in ACI
  <img width="180" alt="image" src="https://user-images.githubusercontent.com/7299171/178064658-605bdefe-3bf9-4fe2-8a15-e5a7ec65867e.png">

After sucessfully completation of pipeline Application is configured in ACI and **az-servian-rg** resource group, servian-techchallenge container group were running which contain two contain 1) postgres run on postgres:latest 2) tech-challenge is on evila/tech-challenge:latest
<img width="938" alt="image" src="https://user-images.githubusercontent.com/7299171/178065192-c63800fb-7001-44c6-b9bc-0919956f17de.png">

And using FQDN of Container instances we can access the application http://servian-techchallenge.westus.azurecontainer.io/ 
<img width="922" alt="image" src="https://user-images.githubusercontent.com/7299171/178065419-61147514-c883-47b0-9a61-fde83246fb0d.png">
and health of application can be check http://servian-techchallenge.westus.azurecontainer.io/healthcheck/
<img width="598" alt="image" src="https://user-images.githubusercontent.com/7299171/178065551-7c47d9f8-42b8-4ce2-ac71-657ee42d8ae6.png">

### Future enhancement
   - Implementing Hashicorp Vault 
   - Implementing hashicorp consul
   - Implementing Terraform project to configure conatiner storage and common resource group that will finally used in above flow.   - 
   - Implementing different environment pipeline with destroy infra structure options  
   - implementing different azure release implementation 

** Issues and Pull requests should only be made for changes to the application code, not Tech Challenge Assessments.**

Please explain the changes you made here.

Fixes: [https://github.com/servian/TechChallengeApp/issues/{issue](https://github.com/servian/TechChallengeApp/issues) number}
